<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scheda Cliente</title>

<!-- PWA meta (lasciati invariati) -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Scheda Cliente">
<meta name="theme-color" content="#0c1a28">

<style>
:root{
  --bg:#0f172a;--panel:#111827;--text:#e5e7eb;--muted:#94a3b8;--border:#1f2937;
  --brand:#ff7a1a;--ok:#22c55e;
  --fs:clamp(12px,1.05vw,15px);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:var(--fs) Inter,system-ui,Arial}
button,input{font:inherit}
.wrap{max-width:1100px;margin:0 auto;padding:14px}
.header{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap}
button{background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
button.primary{background:var(--brand);color:#2d1600;border:none;font-weight:800}
.card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,0));border:1px solid var(--border);border-radius:12px;padding:12px}
.day{border:1px solid var(--border);border-radius:12px;padding:12px;margin:14px 0;background:#0b1220}
.day-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
.day-title{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.day-title h2{margin:0;font-size:20px}
.week-edit{display:flex;align-items:center;gap:10px}
.week-edit .label{font-weight:700;color:var(--text);letter-spacing:.02em}
.week-edit input{width:72px;text-align:center;background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:6px 8px}
.item{border:1px dashed var(--border);border-radius:12px;padding:10px;margin:10px 0}
.row{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr;gap:10px}
.lab{font-size:.85em;color:var(--muted);margin-bottom:4px}
.val{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.val input[type="number"]{width:100%;min-width:0;background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px}
.val input.kg{outline:2px solid var(--ok);box-shadow:0 0 0 2px rgba(34,197,94,.25)}
.tech{display:flex;gap:6px;align-items:center}
.tech .tag{background:#132033;border:1px solid #1f334f;color:#cde1ff;padding:4px 8px;border-radius:999px;font-size:.9em;white-space:nowrap}
.sep{height:1px;background:#1c2a3d;margin:12px 0} /* divisoria tra esercizi */
.meta{font-size:.9em;color:var(--muted)}
.note{margin-top:6px;font-size:.95em;color:#d6d6d6}
img.thumb{width:56px;height:56px;border-radius:10px;border:1px solid var(--border);object-fit:cover;background:#0b1220;margin-right:8px}
.print-note{white-space:pre-wrap}
@media(max-width:820px){
  .row{grid-template-columns:1fr 1fr 1fr}
  .hide-sm{display:none}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1 style="margin:0">Scheda Cliente</h1>
    <div class="toolbar">
      <button id="btn-import" class="primary" type="button">Importa scheda (.ptplan)</button>
      <button id="btn-print" type="button">Stampa / PDF</button>
      <button id="btn-reset" type="button">Reset modifiche</button>
    </div>
  </div>

  <div id="content" class="card">
    <p class="meta">Importa il file .ptplan ricevuto dal coach per visualizzare la scheda. Potrai modificare solo i <b>Kg</b> e il numero di <b>Settimana</b>.</p>
  </div>
</div>

<script>
(function(){
'use strict';

const $=s=>document.querySelector(s);
const esc=s=>String(s??'').replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
const IMG_DBELL='data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect x="2" y="2" width="60" height="60" rx="12" fill="#0b1220" stroke="#1f2937"/><path d="M16 32h32" stroke="#e2e8f0" stroke-width="8" stroke-linecap="round"/><rect x="10" y="22" width="8" height="20" rx="3" fill="#94a3b8"/><rect x="46" y="22" width="8" height="20" rx="3" fill="#94a3b8"/></svg>`);

let plan=null;               // piano importato
let localOver=null;          // override locale: { weekByDayId, kgByItemId }
const LS_KEY='client_overrides_v19';

// carica/salva override (kg & settimana) per persistenza locale
function loadOverrides(){
  try{ localOver=JSON.parse(localStorage.getItem(LS_KEY))||{weekByDayId:{},kgByItemId:{}}; }
  catch{ localOver={weekByDayId:{},kgByItemId:{}}; }
}
function saveOverrides(){
  localStorage.setItem(LS_KEY, JSON.stringify(localOver));
}
loadOverrides();

// Trova nome esercizio abbinato per la tecnica (robusto a vari schemi)
function findPairedExerciseName(item){
  let pairName = item.techPairName || item.techniquePairName || item.pairedExerciseName || item.pairExerciseName || item.tech_exercise || '';
  let pairId   = item.techPairId   || item.techniquePairId   || item.pairedExerciseId   || item.pairExerciseId   || item.tech_ref       || '';

  if(!pairName && pairId){
    if(plan && Array.isArray(plan.exercises)){
      const e = plan.exercises.find(x=>x.id===pairId);
      if(e) pairName = e.name || '';
    }
    if(!pairName && plan && Array.isArray(plan.days)){
      for(const d of plan.days){
        const hit = (d.items||[]).find(x=>x.exerciseId===pairId);
        if(hit){ pairName = hit.exerciseName || ''; break; }
      }
    }
  }
  if(!pairName && item.pairedName) pairName=item.pairedName;
  return pairName;
}

function techniqueLabel(item){
  const t = item.technique || item.tecnica || '';
  if(!t) return '';
  const pair = findPairedExerciseName(item);
  return pair ? `${t} → ${pair}` : t;
}

function hhmm(min,sec){
  if(!min && !sec) return '-';
  const mm = String(min||0).padStart(2,'0');
  const ss = String(sec||0).padStart(2,'0');
  return `${mm}:${ss}`;
}

function render(){
  const host = $('#content');
  if(!plan){ host.innerHTML = `<p class="meta">Importa il file .ptplan ricevuto dal coach per visualizzare la scheda. Potrai modificare solo i <b>Kg</b> e il numero di <b>Settimana</b>.</p>`; return; }

  const title = esc(plan.title || plan.client || 'Scheda');
  let html = `<h2 style="margin:0 0 8px">${title}</h2>`;

  (plan.days||[]).forEach(day=>{
    const dayId = day.id || day.dayId || ('d_'+Math.random().toString(36).slice(2));
    const weekNum = localOver.weekByDayId[dayId] ?? day.week ?? 1;
    const dayName = esc(day.name || '');
    html += `
    <div class="day" data-day="${dayId}">
      <div class="day-head">
        <div class="day-title">
          <h2>${dayName}</h2>
        </div>
        <div class="week-edit">
          <span class="label">SETTIMANA</span>
          <input type="number" min="1" step="1" value="${weekNum}" data-week="${dayId}">
        </div>
      </div>
      ${ (day.items||[]).map((it,idx)=>renderItem(dayId,it,idx)).join('<div class="sep"></div>') }
    </div>`;
  });

  host.innerHTML = html;

  // wire modifica settimana & kg
  (plan.days||[]).forEach(day=>{
    const dayId = day.id || day.dayId;
    const wkInp = host.querySelector(`input[data-week="${CSS.escape(dayId)}"]`);
    if(wkInp){
      wkInp.addEventListener('input', ()=>{
        let v = parseInt(wkInp.value,10);
        if(isNaN(v)||v<1) v = 1;
        localOver.weekByDayId[dayId]=v; saveOverrides();
      });
    }
    (day.items||[]).forEach(it=>{
      const kgId = it.id || it.itemId;
      const inp = host.querySelector(`input[data-kg="${CSS.escape(kgId)}"]`);
      if(inp){
        const initial = localOver.kgByItemId[kgId];
        if(initial!=null) inp.value = initial; // ripristina override
        inp.addEventListener('input', ()=>{
          localOver.kgByItemId[kgId] = inp.value;
          saveOverrides();
        });
      }
    });
  });
}

function renderItem(dayId, it, idx){
  const name = esc(it.exerciseName || it.name || 'Esercizio');
  const img  = esc(it.img || it.image || IMG_DBELL);
  const kgId = esc(it.id || it.itemId || ('it_'+Math.random().toString(36).slice(2)));
  const tech = techniqueLabel(it);
  const notes = esc(it.notes || it.note || '');
  const schemes = Array.isArray(it.schemes)? it.schemes.map(s=>`${s.s}x${s.r}`).join(' • ') : '';
  const rest = hhmm(it.restMin, it.restSec);

  return `
  <div class="item" data-item="${kgId}">
    <div class="val" style="align-items:flex-start">
      <img class="thumb hide-sm" src="${img}" alt="">
      <div>
        <div class="lab">Esercizio</div>
        <div class="val" style="gap:6px"><b>${name}</b></div>
        ${tech? `<div class="tech" style="margin-top:6px"><span class="tag">${esc(tech)}</span></div>`:''}
        ${schemes? `<div class="meta" style="margin-top:6px">Schemi: ${esc(schemes)}</div>`:''}
        ${notes? `<div class="note">Note: <span class="print-note">${notes}</span></div>`:''}
      </div>
    </div>

    <div>
      <div class="lab">Serie</div>
      <div class="val"><span>${esc(it.sets ?? '')}</span></div>
    </div>
    <div>
      <div class="lab">Ripetizioni</div>
      <div class="val"><span>${esc(it.reps ?? '')}</span></div>
    </div>
    <div>
      <div class="lab">Kg</div>
      <div class="val"><input class="kg" data-kg="${kgId}" type="number" min="0" step="0.5" value="${esc(it.kg ?? '')}"></div>
    </div>
    <div>
      <div class="lab">Recupero</div>
      <div class="val"><span>${rest}</span></div>
    </div>
  </div>`;
}

// Import .ptplan
function importPlan(){
  const inp = Object.assign(document.createElement('input'), {type:'file', accept:'.ptplan,.json,application/json'});
  inp.onchange = async ()=>{
    const f = inp.files?.[0]; if(!f) return;
    try{
      const txt = await f.text();
      const data = JSON.parse(txt);

      // Compatibilità export: {plan:{...}} o oggetto piano diretto
      const p = data.plan || data;

      if(!p || !Array.isArray(p.days)) throw new Error('File non valido: mancano i giorni.');

      plan = p;
      render();
      alert('Scheda importata.');
    }catch(e){
      alert('Import fallito: '+e.message);
    }
  };
  inp.click();
}

// Stampa/PDF
function printPDF(){
  if(!plan) return alert('Importa prima una scheda.');
  window.print();
}

// Reset override locali
function resetLocal(){
  if(!plan) return alert('Importa prima una scheda.');
  if(!confirm('Vuoi cancellare i Kg modificati e i numeri di Settimana salvati su questo dispositivo?')) return;
  localOver = {weekByDayId:{}, kgByItemId:{}};
  saveOverrides();
  render();
}

// Wiring
$('#btn-import').addEventListener('click', importPlan);
$('#btn-print').addEventListener('click', printPDF);
$('#btn-reset').addEventListener('click', resetLocal);

})();
</script>
</body>
</html>
